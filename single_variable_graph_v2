import matplotlib.pyplot as plt
import matplotlib.ticker as ticker
import matplotlib.gridspec as gridspec
import pandas as pd
import numpy as np

def smart_plot(data, chart_type='bar', sorting=None, ascending=True, show_na=True, 
               title=None, xlabel=None, ylabel='Counts', color='teal', 
               size=(12, 7), show_labels=True, rotation=90, label_rot=0, 
               label_pad=None, show_boxplot=True):
    
    """
    smart_plot(data, chart_type='bar', sorting=None, ascending=True, show_na=True, 
            title=None, xlabel=None, ylabel='Counts', color='teal', 
            size=(12, 7), show_labels=True, rotation=90, label_rot=0, 
            label_pad=None, show_boxplot=True)

    A robust, "smart" visualization engine designed to handle both categorical and numerical 
    distributions with automatic layout management, dual-frame architectures, and professional 
    formatting standards.

    The function features a "Split-Window" grid for histograms, tiered statistical labeling, 
    and universal comma-separated formatting to ensure readability at any scale (from dozens 
    to millions of records).

    PARAMETERS:
    -----------
    data : array-like (List, NumPy Array, or Pandas Series)
        The input dataset. Can contain strings (categorical) or numbers (numerical).
        NaN values are handled based on the 'show_na' parameter.

    chart_type : str, default 'bar'
        The visualization style to generate:
        - 'bar'     : Categorical counts. Supports comma-separated bar_labels.
        - 'line'    : Trend analysis. Supports comma-separated data point labels.
        - 'scatter' : Distribution view. Labels are disabled for clarity.
        - 'hist'    : Frequency distribution. Triggers the dual-frame GridSpec 
                    layout if 'show_boxplot' is True.

    sorting : str, optional (None or 'freq')
        Determines the order of categories on the X-axis:
        - None   : Sorts alphabetically/numerically by the index names.
        - 'freq' : Sorts based on the count/frequency of each category.
        Note: If 'N/A' is present, it is always pinned to the far right.

    ascending : bool, default True
        Determines the direction of the 'sorting' parameter.

    show_na : bool, default True
        If True, missing values are visualized as an 'N/A' category. 
        If False, missing values are dropped from the visualization.

    title : str, optional
        The main title of the figure. Centered and positioned with a fixed 
        offset to prevent overlap with the top frame.

    xlabel : str, optional
        The centered title for the X-axis. Its vertical distance from the 
        chart is controlled by a dynamic "Safety Buffer" math to accommodate 
        long labels and 90-degree rotations.

    ylabel : str, default 'Counts'
        The title for the Y-axis. The axis ticks are automatically formatted 
        with comma-separators and whole-number rounding.

    color : str, default 'teal'
        The primary color for bars, lines, markers, or histogram bins.

    size : tuple, default (12, 7)
        The (Width, Height) of the resulting figure in inches.

    show_labels : bool, default True
        Toggles the visibility of numeric values on top of bars and line points.
        Values are formatted as comma-separated integers (e.g., 1,498,600).

    rotation : int, default 90
        The rotation angle (degrees) for the X-axis tick labels. 
        Labels are right-aligned ('ha'='right') to ensure they "hang" from 
        the tick marks cleanly, preventing overlap with the axis line.

    label_rot : int, default 0
        The rotation angle for the numeric data labels on bars and lines.
        Maintains a horizontal (0°) orientation by default.

    label_pad : float, optional
        Manual "legroom" adjustment for the xlabel. This value is ADDED to the 
        automatic safety buffer.

    show_boxplot : bool, default True
        Specific to the 'hist' chart_type:
        - True  : Creates a 2-row GridSpec layout. The top frame (the "Penthouse") 
                is a fully-bordered box containing the boxplot and its 
                Five-Point Summary. Top X-axis ticks and the Y-axis "1" are hidden.
        - False : Disables the grid. The histogram fills the entire frame. 
                Triggers a "relaxed" padding math to pull the xlabel closer.

    TIERED BOXPLOT LABELING (for 'hist' mode):
    ------------------------------------------
    When the boxplot is active, the function calculates five distinct statistical 
    labels using pandas-based logic. To maximize space and clarity, these are 
    split into two tiers within the boxplot frame:
    1. TOP TIER: Min, Med, and Max are positioned above the box/whiskers.
    2. BOTTOM TIER: Q1 and Q3 are positioned below the box/whiskers.
    Styling: All five labels are rendered in regular font weight (not bold), 
    black color, center-aligned, and at a slightly smaller font size (size 9) 
    to ensure legibility without crowding.

    INTERNAL LOGIC & DESIGN PRINCIPLES:
    -----------------------------------
    1. UNIVERSAL FORMATTING: All numeric values across the entire plot—including 
    axis ticks, bar labels, and boxplot stats—are formatted as comma-separated 
    integers ({:,.0f}). This eliminates scientific notation for large datasets.

    2. SPLIT-WINDOW GRID: Uses 'matplotlib.gridspec' to physically decouple the 
    boxplot from the histogram. This ensures that the boxplot never sits at 
    the "bottom" of the graph regardless of the histogram's bar height.

    3. SAFETY BUFFER: The padding for the X-axis title is calculated by measuring 
    the longest label in the dataset and factoring in the rotation angle. 
    This ensures that 90-degree "hanging" labels do not overlap with the title.

    4. ALIGNMENT SYNC: The top boxplot frame and bottom histogram frame are 
    horizontally locked. A vertical scan from a statistical marker in the 
    boxplot will align perfectly with the corresponding numeric bin below.

    RETURNS:
    --------
    None. Displays the plot directly via plt.show().
    """
    
    # 1. DATA PROCESSING
    s = pd.Series(data)
    if show_na:
        s = s.fillna('N/A')
    
    if chart_type == 'hist':
        plot_data = s.dropna() if not show_na else s
    else:
        counts = s.value_counts(dropna=not show_na)
        if sorting == 'freq':
            counts = counts.sort_values(ascending=ascending)
        else:
            is_na = counts.index.astype(str) == 'N/A'
            sorted_idx = counts[~is_na].sort_index(ascending=ascending).index.tolist()
            if is_na.any():
                sorted_idx.append('N/A')
            counts = counts.reindex(sorted_idx)

    # 2. FIGURE SETUP (Grid Logic for Histogram)
    fig = plt.figure(figsize=size)
    
    if chart_type == 'hist' and show_boxplot:
        # Increased height ratio for boxplot to fit dual-tier labels
        gs = gridspec.GridSpec(2, 1, height_ratios=[2.2, 7.8], hspace=0.08)
        ax_box = fig.add_subplot(gs[0])
        ax = fig.add_subplot(gs[1])
    else:
        ax = fig.add_subplot(1, 1, 1)

    # 3. UNIVERSAL FORMATTER
    comma_fmt = ticker.FuncFormatter(lambda x, p: f'{x:,.0f}')

    # 4. PLOT EXECUTION
    if chart_type == 'bar':
        rects = ax.bar(counts.index.astype(str), counts.values, color=color, edgecolor='black')
        if show_labels:
            # Comma-separated whole integers for bar labels
            ax.bar_label(rects, padding=3, rotation=label_rot, 
                         labels=[f'{x:,.0f}' for x in counts.values], 
                         fontweight='bold', color='black')

    elif chart_type == 'line':
        ax.plot(counts.index.astype(str), counts.values, marker='o', color=color, linewidth=2)
        if show_labels:
            for i, v in enumerate(counts.values):
                ax.text(i, v + (max(counts.values)*0.02), f'{v:,.0f}', 
                        ha='right' if label_rot != 0 else 'center', rotation=label_rot, 
                        fontweight='bold', color='black')

    elif chart_type == 'scatter':
        ax.scatter(counts.index.astype(str), counts.values, color=color, s=100, edgecolor='black', alpha=0.7)

    elif chart_type == 'hist':
        n, bins, patches = ax.hist(plot_data, bins='auto', color=color, edgecolor='black', alpha=0.7)
        ax.xaxis.set_major_formatter(comma_fmt) # Comma-formatted bins
        
        if show_boxplot:
            stats = plot_data.describe()
            ax_box.boxplot(plot_data, vert=False, widths=0.4, patch_artist=True,
                           boxprops=dict(facecolor='white', color='black'),
                           medianprops=dict(color='red', linewidth=2))
            
            # Tiered Labels: Black, Center-Aligned, Regular Weight, Small Font
            # Top Tier: Min, Med, Max
            top_stats = {'Min': stats['min'], 'Med': stats['50%'], 'Max': stats['max']}
            for label, val in top_stats.items():
                ax_box.text(val, 1.45, f'{label}: {val:,.0f}', ha='center', va='bottom', 
                            color='black', fontsize=9)
            
            # Bottom Tier: Q1, Q3
            bottom_stats = {'Q1': stats['25%'], 'Q3': stats['75%']}
            for label, val in bottom_stats.items():
                ax_box.text(val, 0.55, f'{label}: {val:,.0f}', ha='center', va='top', 
                            color='black', fontsize=9)
            
            # Formatting Boxplot Frame
            ax_box.set_xlim(ax.get_xlim()) 
            ax_box.set_xticks([])          # Hide top x-ticks
            ax_box.set_yticks([])          # Hide the "1"
            for spine in ax_box.spines.values(): spine.set_visible(True)

    # 5. MARGINS, SPINES, & THE SAFETY BUFFER
    for spine in ax.spines.values(): spine.set_visible(True)

    # Rotate Ticks and set Right-Alignment ("Hanging")
    ax.tick_params(axis='x', labelrotation=rotation)
    plt.setp(ax.get_xticklabels(), ha='right' if rotation != 0 else 'center')

    # Label Pad Math
    if xlabel:
        if chart_type == 'hist':
            max_len = 8 # Accommodate comma-formatted bin numbers
        else:
            max_len = max([len(str(l)) for l in counts.index])
        
        auto_pad = (max_len * 4) if rotation > 45 else 10
        if not (chart_type == 'hist' and show_boxplot):
            auto_pad = auto_pad * 0.7 
            
        final_pad = auto_pad + (label_pad if label_pad is not None else 0)
        ax.set_xlabel(xlabel, labelpad=final_pad, fontweight='bold')

    # 6. FINAL STYLING
    if title:
        fig.suptitle(title, fontsize=14, fontweight='bold', y=0.98)
    
    ax.set_ylabel(ylabel, fontweight='bold')
    ax.yaxis.set_major_formatter(comma_fmt)
    
    plt.tight_layout(rect=[0, 0.03, 1, 0.95])
    plt.show()
