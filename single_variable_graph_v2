import matplotlib.pyplot as plt
import matplotlib.ticker as ticker
import matplotlib.gridspec as gridspec
import pandas as pd
import numpy as np

def smart_plot(data, chart_type='bar', sorting=None, ascending=True, show_na=True, 
               title=None, xlabel=None, ylabel='Counts', color='teal', 
               size=(12, 7), show_labels=True, rotation=90, label_rot=0, 
               label_pad=None, show_boxplot=True):
    
    """
    smart_plot(data, chart_type='bar', sorting=None, ascending=True, show_na=True, 
            title=None, xlabel=None, ylabel='Counts', color='teal', 
            size=(12, 7), show_labels=True, rotation=90, label_rot=0, 
            label_pad=None, show_boxplot=True)

    A highly intelligent visualization engine designed to handle categorical and numerical 
    distributions with automatic layout management and professional-grade aesthetics.

    The function features a "Split-Window" architecture for histograms, dynamic "Safety 
    Buffer" calculations for axis titles, and persistent statistical overlays.

    PARAMETERS:
    -----------
    data : array-like (List, NumPy Array, or Pandas Series)
        The input dataset. Can contain strings (categorical) or numbers (numerical).
        NaN values are handled based on the 'show_na' parameter.

    chart_type : str, default 'bar'
        The visualization style to generate:
        - 'bar'     : Categorical counts. Supports bar_labels.
        - 'line'    : Trend analysis. Supports data point labels.
        - 'scatter' : Distribution view. Labels are disabled for clarity.
        - 'hist'    : Frequency distribution. Triggers the dual-frame GridSpec 
                    layout if 'show_boxplot' is True.

    sorting : str, optional (None or 'freq')
        Determines the order of categories on the X-axis:
        - None   : Sorts alphabetically/numerically by the index names.
        - 'freq' : Sorts based on the count/frequency of each category.
        Note: If 'N/A' is present, it is always pinned to the far right.

    ascending : bool, default True
        Determines the direction of the 'sorting' parameter.

    show_na : bool, default True
        If True, missing values are visualized as an 'N/A' category. 
        If False, missing values are dropped from the visualization.

    title : str, optional
        The main title of the figure. Positioned with a fixed 'y' offset to 
        prevent overlap with the top frame or boxplot labels.

    xlabel : str, optional
        The centered title for the X-axis. Its vertical distance from the 
        chart is controlled by the dynamic "Safety Buffer" math.

    ylabel : str, default 'Counts'
        The title for the Y-axis. Automatically formatted with thousands-separators.

    color : str, default 'teal'
        The primary color for bars, lines, markers, or histogram bins.

    size : tuple, default (12, 7)
        The (Width, Height) of the resulting figure in inches.

    show_labels : bool, default True
        Toggles the visibility of numeric values on top of bars and line points.
        Does not affect Boxplot statistical labels (which are persistent).

    rotation : int, default 90
        The rotation angle (degrees) for the X-axis tick labels. 
        Labels are right-aligned ('ha'='right') to ensure they "hang" from 
        the tick marks when rotated, preventing overlap with the axis line.

    label_rot : int, default 0
        The rotation angle for the numeric data labels on bars and lines.
        Maintains a horizontal (0°) orientation by default for maximum readability.

    label_pad : float, optional
        Manual "legroom" adjustment for the xlabel. This value is ADDED to the 
        automatic safety buffer. Use this if your labels are unusually wide.

    show_boxplot : bool, default True
        Specific to 'hist' chart_type.
        - True  : Creates a 2-row GridSpec. The top row (15% height) contains 
                a fully-bordered boxplot with persistent black labels for 
                Min, Median, and Max. The top X-axis ticks are hidden.
        - False : Disables the grid. The histogram fills the entire frame. 
                Triggers "Relaxed Padding" (Option A) for a tighter title gap.

    INTERNAL LOGIC & DESIGN PRINCIPLES:
    -----------------------------------
    1. THE SPLIT-WINDOW GRID: 
    In histogram mode, the function utilizes 'matplotlib.gridspec' to physically 
    decouple the Boxplot from the Histogram. This ensures the Boxplot always 
    sits in a "Penthouse" frame above the data, avoiding the bottom-squish 
    common in dual-axis plots.

    2. THE SAFETY BUFFER (DYNAMIC PADDING):
    The function calculates the length of the longest X-axis label and the 
    specified rotation to determine how much vertical space is needed. 
    - Vertical labels (90°) trigger a larger buffer (~4pts per character).
    - Horizontal labels (0°) trigger a standard tight buffer.
    - If 'show_boxplot' is False, the buffer is "relaxed" (reduced by 30%) 
        to provide a more compact and integrated look.

    3. PERSISTENT STATISTICS:
    Regardless of the 'color' parameter, boxplot statistical labels (Min, Med, 
    Max) and data labels on bars/lines are rendered in BLACK to ensure 
    mathematical clarity against colorful backgrounds.

    4. ALIGNMENT SYNC:
    The Top Boxplot frame and Bottom Histogram frame are hard-linked on the 
    X-axis. A vertical scan from a boxplot feature (like the Median line) 
    will land perfectly on the corresponding value in the histogram.

    RETURNS:
    --------
    None. Displays the plot directly via plt.show().
    """
    
    # 1. DATA PROCESSING
    s = pd.Series(data)
    if show_na:
        s = s.fillna('N/A')
    
    if chart_type == 'hist':
        plot_data = s.dropna() if not show_na else s
    else:
        counts = s.value_counts(dropna=not show_na)
        if sorting == 'freq':
            counts = counts.sort_values(ascending=ascending)
        else:
            is_na = counts.index.astype(str) == 'N/A'
            sorted_idx = counts[~is_na].sort_index(ascending=ascending).index.tolist()
            if is_na.any():
                sorted_idx.append('N/A')
            counts = counts.reindex(sorted_idx)

    # 2. FIGURE SETUP (Grid Logic for Histogram)
    fig = plt.figure(figsize=size)
    
    if chart_type == 'hist' and show_boxplot:
        gs = gridspec.GridSpec(2, 1, height_ratios=[1.5, 8.5], hspace=0.05)
        ax_box = fig.add_subplot(gs[0])
        ax = fig.add_subplot(gs[1])
    else:
        ax = fig.add_subplot(1, 1, 1)

    # 3. PLOT EXECUTION
    if chart_type == 'bar':
        rects = ax.bar(counts.index.astype(str), counts.values, color=color, edgecolor='black')
        if show_labels:
            ax.bar_label(rects, padding=3, rotation=label_rot, fmt='%g', fontweight='bold', color='black')

    elif chart_type == 'line':
        ax.plot(counts.index.astype(str), counts.values, marker='o', color=color, linewidth=2)
        if show_labels:
            for i, v in enumerate(counts.values):
                ax.text(i, v + (max(counts.values)*0.02), f'{v:g}', 
                        ha='right' if label_rot != 0 else 'center', rotation=label_rot, 
                        fontweight='bold', color='black')

    elif chart_type == 'scatter':
        ax.scatter(counts.index.astype(str), counts.values, color=color, s=100, edgecolor='black', alpha=0.7)

    elif chart_type == 'hist':
        # Main Histogram
        n, bins, patches = ax.hist(plot_data, bins='auto', color=color, edgecolor='black', alpha=0.7)
        
        if show_boxplot:
            # Boxplot in the 'Penthouse'
            stats = plot_data.describe()
            ax_box.boxplot(plot_data, vert=False, widths=0.4, patch_artist=True,
                           boxprops=dict(facecolor='white', color='black'),
                           medianprops=dict(color='red', linewidth=2))
            
            # Persistent Black Labels
            stat_vals = {'Min': stats['min'], 'Max': stats['max'], 'Med': stats['50%']}
            for label, val in stat_vals.items():
                ax_box.text(val, 1.4, f'{label}: {val:g}', ha='center', va='bottom', 
                            color='black', fontsize=9, fontweight='bold')
            
            # Formatting Boxplot Frame
            ax_box.set_xlim(ax.get_xlim()) # Sync scales
            ax_box.set_xticks([])          # Hide middle tick labels
            for spine in ax_box.spines.values(): spine.set_visible(True) # Full border

    # 4. MARGINS, SPINES, & THE SAFETY BUFFER
    # Ensure full frames for main plot
    for spine in ax.spines.values(): spine.set_visible(True)

    # Rotate Ticks for everything (including numeric bins)
    ax.tick_params(axis='x', labelrotation=rotation)
    plt.setp(ax.get_xticklabels(), ha='right' if rotation != 0 else 'center')

    # Label Pad Math
    if xlabel:
        if chart_type == 'hist':
            max_len = 6 # Typical number length
        else:
            max_len = max([len(str(l)) for l in counts.index])
        
        # Buffer calculation: Approx 4 pts per char if 90 degrees
        auto_pad = (max_len * 4) if rotation > 45 else 10
        
        # Option A: Relaxed padding if boxplot is off
        if not (chart_type == 'hist' and show_boxplot):
            auto_pad = auto_pad * 0.7 
            
        final_pad = auto_pad + (label_pad if label_pad is not None else 0)
        ax.set_xlabel(xlabel, labelpad=final_pad, fontweight='bold')

    # 5. FINAL STYLING
    if title:
        fig.suptitle(title, fontsize=14, fontweight='bold', y=0.98)
    ax.set_ylabel(ylabel, fontweight='bold')
    ax.yaxis.set_major_formatter(ticker.StrMethodFormatter('{x:,.0f}'))
    
    plt.tight_layout(rect=[0, 0.03, 1, 0.95])
    plt.show()
