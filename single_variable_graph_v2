import matplotlib.pyplot as plt
import matplotlib.ticker as ticker
import matplotlib.gridspec as gridspec
import pandas as pd
import numpy as np

def smart_plot(data, chart_type='bar', sorting=None, ascending=True, show_na=True, 
               title=None, xlabel=None, ylabel='Counts', color='teal', 
               size=(12, 7), show_labels=True, rotation=90, label_rot=0, 
               label_pad=None, show_boxplot=True):
    """
    Capable AI Thought Partner: Final Integrated Smart Plot.
    
    Features:
    - Split-Window Grid for Histograms (Boxplot on top).
    - Dynamic 'Safety Buffer' for centered X-axis titles.
    - Persistent, black statistical labels for boxplots.
    - Right-aligned 'hanging' ticks for rotated labels.
    """
    
    # 1. DATA PROCESSING
    s = pd.Series(data)
    if show_na:
        s = s.fillna('N/A')
    
    if chart_type == 'hist':
        plot_data = s.dropna() if not show_na else s
    else:
        counts = s.value_counts(dropna=not show_na)
        if sorting == 'freq':
            counts = counts.sort_values(ascending=ascending)
        else:
            is_na = counts.index.astype(str) == 'N/A'
            sorted_idx = counts[~is_na].sort_index(ascending=ascending).index.tolist()
            if is_na.any():
                sorted_idx.append('N/A')
            counts = counts.reindex(sorted_idx)

    # 2. FIGURE SETUP (Grid Logic for Histogram)
    fig = plt.figure(figsize=size)
    
    if chart_type == 'hist' and show_boxplot:
        gs = gridspec.GridSpec(2, 1, height_ratios=[1.5, 8.5], hspace=0.05)
        ax_box = fig.add_subplot(gs[0])
        ax = fig.add_subplot(gs[1])
    else:
        ax = fig.add_subplot(1, 1, 1)

    # 3. PLOT EXECUTION
    if chart_type == 'bar':
        rects = ax.bar(counts.index.astype(str), counts.values, color=color, edgecolor='black')
        if show_labels:
            ax.bar_label(rects, padding=3, rotation=label_rot, fmt='%g', fontweight='bold', color='black')

    elif chart_type == 'line':
        ax.plot(counts.index.astype(str), counts.values, marker='o', color=color, linewidth=2)
        if show_labels:
            for i, v in enumerate(counts.values):
                ax.text(i, v + (max(counts.values)*0.02), f'{v:g}', 
                        ha='right' if label_rot != 0 else 'center', rotation=label_rot, 
                        fontweight='bold', color='black')

    elif chart_type == 'scatter':
        ax.scatter(counts.index.astype(str), counts.values, color=color, s=100, edgecolor='black', alpha=0.7)

    elif chart_type == 'hist':
        # Main Histogram
        n, bins, patches = ax.hist(plot_data, bins='auto', color=color, edgecolor='black', alpha=0.7)
        
        if show_boxplot:
            # Boxplot in the 'Penthouse'
            stats = plot_data.describe()
            ax_box.boxplot(plot_data, vert=False, widths=0.4, patch_artist=True,
                           boxprops=dict(facecolor='white', color='black'),
                           medianprops=dict(color='red', linewidth=2))
            
            # Persistent Black Labels
            stat_vals = {'Min': stats['min'], 'Max': stats['max'], 'Med': stats['50%']}
            for label, val in stat_vals.items():
                ax_box.text(val, 1.4, f'{label}: {val:g}', ha='center', va='bottom', 
                            color='black', fontsize=9, fontweight='bold')
            
            # Formatting Boxplot Frame
            ax_box.set_xlim(ax.get_xlim()) # Sync scales
            ax_box.set_xticks([])          # Hide middle tick labels
            for spine in ax_box.spines.values(): spine.set_visible(True) # Full border

    # 4. MARGINS, SPINES, & THE SAFETY BUFFER
    # Ensure full frames for main plot
    for spine in ax.spines.values(): spine.set_visible(True)

    # Rotate Ticks for everything (including numeric bins)
    ax.tick_params(axis='x', labelrotation=rotation)
    plt.setp(ax.get_xticklabels(), ha='right' if rotation != 0 else 'center')

    # Label Pad Math
    if xlabel:
        if chart_type == 'hist':
            max_len = 6 # Typical number length
        else:
            max_len = max([len(str(l)) for l in counts.index])
        
        # Buffer calculation: Approx 4 pts per char if 90 degrees
        auto_pad = (max_len * 4) if rotation > 45 else 10
        
        # Option A: Relaxed padding if boxplot is off
        if not (chart_type == 'hist' and show_boxplot):
            auto_pad = auto_pad * 0.7 
            
        final_pad = auto_pad + (label_pad if label_pad is not None else 0)
        ax.set_xlabel(xlabel, labelpad=final_pad, fontweight='bold')

    # 5. FINAL STYLING
    if title:
        fig.suptitle(title, fontsize=14, fontweight='bold', y=0.98)
    ax.set_ylabel(ylabel, fontweight='bold')
    ax.yaxis.set_major_formatter(ticker.StrMethodFormatter('{x:,.0f}'))
    
    plt.tight_layout(rect=[0, 0.03, 1, 0.95])
    plt.show()
